<app-page-title></app-page-title>

<!--change from grouped indicator to multi-select-->

<div class="card card-edit">

    <div class="card-header">

        <div class="card-header-title">
            <h4>Chart<span *ngIf="!!chart?.name">: {{chart.name}}</span></h4>
            <div>
                <i class="fa fa-fw ms-1 fa-cloud-download cursor-pointer ms-2" ngbTooltip="Download as image" (click)="downloadChart()" *ngIf="options"></i>
                <i class="fa fa-fw ms-1 fa-gear cursor-pointer ms-2" ngbTooltip="Download as image" (click)="offCanvas(settingsPanel, 'end')"></i>
            </div>
        </div>

    </div>

    <div class="card-body">

        <div *ngIf="options" echarts [options]="options" (chartInit)="onChartInit($event)" [style.height.px]="settings.height"></div>

        <div *ngIf="!options && chart" class="alert alert-info cursor-pointer" (click)="offCanvas(settingsPanel, 'end')">
            Configure your chart settings to produce the chart.
        </div>

    </div>

</div>

<ng-template #settingsPanel let-offcanvas>

    <div class="offcanvas-body p-0">
        
        <form id="form" name="form" novalidate #form="ngForm" [ngClass]="{ 'was-validated': form.submitted }">

            <div ngbAccordion [closeOthers]="true">

                <div ngbAccordionItem [collapsed]="false">
                    <h2 ngbAccordionHeader>
                        <button ngbAccordionButton tabindex="-1">General</button>
                    </h2>
                    <div ngbAccordionCollapse>
                        <div ngbAccordionBody>
                            <ng-template>

                                <fieldset class="group">

                                    <div class="row gx-3">

                                        <div class="col-sm-12">
                                            <div class="form-group">

                                                <label for="name">
                                                    Chart Name:
                                                </label>

                                                <input id="name" name="name" class="form-control" type="text" [(ngModel)]="chart.name" #name="ngModel" required (ngModelChange)="changeBreadcrumb()" maxlength="200" />

                                                <div *ngIf="name.errors?.required" class="invalid-feedback">
                                                    Name is required
                                                </div>

                                                <div *ngIf="name.errors?.maxlength" class="invalid-feedback">
                                                    Name must be at most 200 characters long
                                                </div>

                                            </div>
                                        </div>

                                        <div class="col-12">
                                            <div class="form-group">

                                                <label for="xAxisSort" class="me-4">
                                                    Sorting:
                                                </label>

                                                <div>
                                                    <div class="form-check form-check-inline">
                                                        <input type="radio"
                                                               id="xAxisSortByName"
                                                               name="xAxisSort"
                                                               class="form-check-input"
                                                               [(ngModel)]="settings.xAxisSort"
                                                               #xAxisSortByName="ngModel"
                                                               [value]="'name'"
                                                               (ngModelChange)="settingChanged()" />
                                                        <label class="form-check-label" for="xAxisSortByName">Entity Name</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input type="radio"
                                                               id="xAxisSortByValue"
                                                               name="xAxisSort"
                                                               class="form-check-input"
                                                               [(ngModel)]="settings.xAxisSort"
                                                               #xAxisSortByValue="ngModel"
                                                               [value]="'value'"
                                                               (ngModelChange)="settingChanged()" />
                                                        <label class="form-check-label" for="xAxisSortByValue">Primary Axis Value</label>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>

                                        <div class="col-12">
                                            <div class="form-group">

                                                <label for="entities">
                                                    Entities:
                                                </label>

                                                <div class="w-100">
                                                    <button id="entities" name="entities" type="button" class="btn w-100 btn-outline-secondary" (click)="entityModal.open()">Entities ({{settings.entityIds.length}} selected)</button>
                                                </div>

                                            </div>
                                        </div>

                                        <div class="col-12" *ngIf="!isNew">
                                            <div class="form-group">

                                                <div class="w-100">
                                                    <button id="deleteChart" name="deleteChart" type="button" class="btn w-100 btn-outline-danger" (click)="deleteChart()">Delete Chart</button>
                                                </div>

                                            </div>
                                        </div>

                                    </div>

                                </fieldset>

                            </ng-template>
                        </div>
                    </div>
                </div>

                <div ngbAccordionItem [collapsed]="false">
                    <h2 ngbAccordionHeader>
                        <button ngbAccordionButton tabindex="-1">Primary Axis</button>
                    </h2>
                    <div ngbAccordionCollapse>
                        <div ngbAccordionBody>
                            <ng-template>

                                <fieldset class="group">

                                    <div class="row gx-3">

                                        <div class="col-12">
                                            <div class="form-group">

                                                <label for="primaryAxisIndicatorIds">
                                                    Indicators:
                                                </label>

                                                <indicator-select id="primaryAxisIndicatorIds" name="primaryAxisIndicatorIds" [(indicators)]="settingsObjects.primaryAxisIndicators" [(ngModel)]="settings.primaryAxisIndicatorIds" [multiple]="true" #primaryAxisIndicatorIds="ngModel" required (ngModelChange)="loadData()"></indicator-select>

                                                <div *ngIf="primaryAxisIndicatorIds.errors?.required" class="invalid-feedback">
                                                    Indicator is required
                                                </div>

                                            </div>
                                        </div>

                                        <div class="col-6">
                                            <div class="form-group">

                                                <label for="showPrimaryAxisTitle">
                                                    Title:
                                                </label>

                                                <div class="form-check">
                                                    <input id="showPrimaryAxisTitle" name="showPrimaryAxisTitle" class="form-check-input" type="checkbox" [(ngModel)]="settings.showPrimaryAxisTitle" #showPrimaryAxisTitle="ngModel" (ngModelChange)="settingChanged()" />
                                                    <label class="form-check-label" for="showPrimaryAxisTitle">
                                                        Show
                                                    </label>
                                                </div>

                                            </div>
                                        </div>

                                        <div class="col-6">
                                            <div class="form-group">

                                                <label for="primaryAxisTitleGap">
                                                    Title Gap:
                                                </label>

                                                <input id="primaryAxisTitleGap" name="primaryAxisTitleGap" type="number" class="form-control" [(ngModel)]="settings.primaryAxisTitleGap" [disabled]="!settings.showPrimaryAxisTitle" #primaryAxisTitleGap="ngModel" (ngModelChange)="settingChanged()" />

                                            </div>
                                        </div>

                                        <div class="col-12">
                                            <div class="form-group">

                                                <label for="primaryAxisTitleText">
                                                    Title Text:
                                                </label>

                                                <input id="primaryAxisTitleText" name="primaryAxisTitleText" type="text" class="form-control" [(ngModel)]="settings.primaryAxisTitleText" [disabled]="!settings.showPrimaryAxisTitle" #primaryAxisTitleText="ngModel" (ngModelChange)="settingChanged()" />

                                            </div>
                                        </div>

                                        <div class="col-6">
                                            <div class="form-group">

                                                <label for="primaryAxisFontSize">
                                                    Font Size:
                                                </label>

                                                <input id="primaryAxisFontSize" name="primaryAxisFontSize" type="number" class="form-control" [(ngModel)]="settings.primaryAxisFontSize" #primaryAxisFontSize="ngModel" (ngModelChange)="settingChanged()" />

                                            </div>
                                        </div>

                                        <div class="col-6" *ngIf="settings.primaryAxisIndicatorIds.length > 1">
                                            <div class="form-group">

                                                <label for="stackType">
                                                    Stacking:
                                                </label>

                                                <select id="stackType"
                                                        name="stackType"
                                                        class="form-select"
                                                        [(ngModel)]="settings.stackType"
                                                        #stackType="ngModel"
                                                        (ngModelChange)="settingChanged()">

                                                    <option [ngValue]="StackTypes.None">None</option>
                                                    <option [ngValue]="StackTypes.Normal">Stacked: Normal</option>
                                                    <option [ngValue]="StackTypes.Percent">Stacked: Percentage</option>

                                                </select>

                                            </div>
                                        </div>

                                    </div>

                                </fieldset>

                            </ng-template>
                        </div>
                    </div>
                </div>

                <div ngbAccordionItem [collapsed]="false">
                    <h2 ngbAccordionHeader>
                        <button ngbAccordionButton tabindex="-1">Secondary Axis</button>
                    </h2>
                    <div ngbAccordionCollapse>
                        <div ngbAccordionBody>
                            <ng-template>

                                <fieldset class="group">

                                    <div class="row gx-3">

                                        <div class="col-12">
                                            <div class="form-group">

                                                <label for="secondaryAxisIndicators">
                                                    Indicators:
                                                </label>

                                                <indicator-select id="secondaryAxisIndicators" name="secondaryAxisIndicators" [(indicators)]="settingsObjects.secondaryAxisIndicators" [(ngModel)]="settings.secondaryAxisIndicatorIds" [multiple]="true" #secondaryAxisIndicators="ngModel" (ngModelChange)="loadData()"></indicator-select>

                                            </div>
                                        </div>


                                        <div class="col-6">
                                            <div class="form-group">

                                                <label for="showSecondaryAxisTitle">
                                                    Title:
                                                </label>

                                                <div class="form-check">
                                                    <input id="showSecondaryAxisTitle" name="showSecondaryAxisTitle" class="form-check-input" type="checkbox" [(ngModel)]="settings.showSecondaryAxisTitle" #showSecondaryAxisTitle="ngModel" (ngModelChange)="settingChanged()" />
                                                    <label class="form-check-label" for="showSecondaryAxisTitle">
                                                        Show
                                                    </label>
                                                </div>

                                            </div>
                                        </div>

                                        <div class="col-6">
                                            <div class="form-group">

                                                <label for="secondaryAxisTitleGap">
                                                    Title Gap:
                                                </label>

                                                <input id="secondaryAxisTitleGap" name="secondaryAxisTitleGap" type="number" class="form-control" [(ngModel)]="settings.secondaryAxisTitleGap" [disabled]="!settings.showSecondaryAxisTitle" #secondaryAxisTitleGap="ngModel" (ngModelChange)="settingChanged()" />

                                            </div>
                                        </div>

                                        <div class="col-12">
                                            <div class="form-group">

                                                <label for="secondaryAxisTitleText">
                                                    Title Text:
                                                </label>

                                                <input id="secondaryAxisTitleText" name="secondaryAxisTitleText" type="text" class="form-control" [(ngModel)]="settings.secondaryAxisTitleText" [disabled]="!settings.showSecondaryAxisTitle" #secondaryAxisTitleText="ngModel" (ngModelChange)="settingChanged()" />

                                            </div>
                                        </div>

                                        <div class="col-6">
                                            <div class="form-group">

                                                <label for="secondaryAxisFontSize">
                                                    Font Size:
                                                </label>

                                                <input id="secondaryAxisFontSize" name="secondaryAxisFontSize" type="number" class="form-control" [(ngModel)]="settings.secondaryAxisFontSize" #secondaryAxisFontSize="ngModel" (ngModelChange)="settingChanged()" />

                                            </div>
                                        </div>

                                    </div>

                                </fieldset>

                            </ng-template>
                        </div>
                    </div>
                </div>

                <div ngbAccordionItem>
                    <h2 ngbAccordionHeader>
                        <button ngbAccordionButton tabindex="-1">Appearance</button>
                    </h2>
                    <div ngbAccordionCollapse>
                        <div ngbAccordionBody>
                            <ng-template>

                                <fieldset class="group">

                                    <div class="row gx-3">

                                        <div class="col-6">
                                            <div class="form-group">

                                                <label for="barColor">
                                                    Bar Color:
                                                </label>

                                                <app-color id="barColor" name="barColor" [(ngModel)]="settings.barColor" #barColor="ngModel" (ngModelChange)="settingChanged()"></app-color>

                                            </div>
                                        </div>

                                        <div class="col-6">
                                            <div class="form-group">

                                                <label for="lineColor">
                                                    Line Color:
                                                </label>

                                                <app-color id="lineColor" name="lineColor" [(ngModel)]="settings.lineColor" #barColor="ngModel" (ngModelChange)="settingChanged()"></app-color>

                                            </div>
                                        </div>

                                        <div class="col-6">
                                            <div class="form-group">

                                                <label for="lineWidth">
                                                    Line Width:
                                                </label>

                                                <input id="lineWidth" name="lineWidth" type="number" class="form-control" [(ngModel)]="settings.lineWidth" #lineWidth="ngModel" (ngModelChange)="settingChanged()" />

                                            </div>
                                        </div>

                                        <div class="col-6">
                                            <div class="form-group">

                                                <label for="lineMarkerSize">
                                                    Line Marker Size:
                                                </label>

                                                <input id="lineMarkerSize" name="lineMarkerSize" class="form-control" type="number" [(ngModel)]="settings.lineMarkerSize" #lineMarkerSize="ngModel" (ngModelChange)="settingChanged()" />

                                            </div>
                                        </div>

                                        <div class="col-6">
                                            <div class="form-group">

                                                <label for="legendPosition">
                                                    Legend Position:
                                                </label>

                                                <select id="legendPosition"
                                                        name="legendPosition"
                                                        class="form-select"
                                                        [(ngModel)]="settings.legendPosition"
                                                        #legendPosition="ngModel"
                                                        (ngModelChange)="settingChanged()">

                                                    <option [ngValue]="LegendPosition.None">None</option>
                                                    <option [ngValue]="LegendPosition.Top">Top</option>
                                                    <option [ngValue]="LegendPosition.Bottom">Bottom</option>

                                                </select>

                                            </div>
                                        </div>

                                    </div>

                                </fieldset>

                            </ng-template>
                        </div>
                    </div>
                </div>

                <div ngbAccordionItem>
                    <h2 ngbAccordionHeader>
                        <button ngbAccordionButton>Axes</button>
                    </h2>
                    <div ngbAccordionCollapse>
                        <div ngbAccordionBody>
                            <ng-template>

                                <fieldset class="group">

                                    <div class="row gx-3">

                                        <div class="col-6">
                                            <div class="form-group">

                                                <label for="xAxisFontSize">
                                                    X-Axis Font Size:
                                                </label>

                                                <input id="xAxisFontSize" name="xAxisFontSize" type="number" class="form-control" [(ngModel)]="settings.xAxisFontSize" #xAxisFontSize="ngModel" (ngModelChange)="settingChanged()" />

                                            </div>
                                        </div>

                                        <div class="col-6">
                                            <div class="form-group">

                                                <label for="xAxisRotation">
                                                    X-Axis Rotation:
                                                </label>

                                                <input id="xAxisRotation" name="xAxisRotation" type="number" class="form-control" [(ngModel)]="settings.xAxisRotation" #xAxisRotation="ngModel" (ngModelChange)="settingChanged()" />

                                            </div>
                                        </div>


                                    </div>

                                </fieldset>

                            </ng-template>
                        </div>
                    </div>
                </div>

                <div ngbAccordionItem>
                    <h2 ngbAccordionHeader>
                        <button ngbAccordionButton>Layout</button>
                    </h2>
                    <div ngbAccordionCollapse>
                        <div ngbAccordionBody>
                            <ng-template>

                                <fieldset class="group">

                                    <div class="row gx-3">

                                        <div class="col-6">
                                            <div class="form-group">

                                                <label for="height">
                                                    Height:
                                                </label>

                                                <input id="height" name="height" type="number" class="form-control" [(ngModel)]="settings.height" #height="ngModel" (ngModelChange)="settingChanged()" />

                                            </div>
                                        </div>

                                    </div>

                                    <div class="row gx-3">

                                        <div class="col-6">
                                            <div class="form-group">

                                                <label for="gridLeft">
                                                    Grid Left:
                                                </label>

                                                <input id="gridLeft" name="gridLeft" type="number" class="form-control" [(ngModel)]="settings.gridLeft" #gridLeft="ngModel" (ngModelChange)="settingChanged()" />

                                            </div>
                                        </div>

                                        <div class="col-6">
                                            <div class="form-group">

                                                <label for="gridRight">
                                                    Grid Right:
                                                </label>

                                                <input id="gridRight" name="gridRight" type="number" class="form-control" [(ngModel)]="settings.gridRight" #gridRight="ngModel" (ngModelChange)="settingChanged()" />

                                            </div>
                                        </div>

                                        <div class="col-6">
                                            <div class="form-group">

                                                <label for="gridTop">
                                                    Grid Top:
                                                </label>

                                                <input id="gridTop" name="gridTop" type="number" class="form-control" [(ngModel)]="settings.gridTop" #gridTop="ngModel" (ngModelChange)="settingChanged()" />

                                            </div>
                                        </div>

                                        <div class="col-6">
                                            <div class="form-group">

                                                <label for="gridBottom">
                                                    Grid Bottom:
                                                </label>

                                                <input id="gridBottom" name="gridBottom" type="number" class="form-control" [(ngModel)]="settings.gridBottom" #gridBottom="ngModel" (ngModelChange)="settingChanged()" />

                                            </div>
                                        </div>

                                    </div>

                                </fieldset>

                            </ng-template>
                        </div>
                    </div>
                </div>

            </div>

        </form>

    </div>

</ng-template>

<entity-modal #entityModal (changes)="entitiesChanged($event)" [multiple]="true" [selectedItems]="settingsObjects.entities"></entity-modal>
